name: DevSecOps Pipeline - Akaunting

on:
  workflow_dispatch:

jobs:
  ci:
    name: CI - Build & Push to ECR
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: docker build -t akaunting-app .

      - name: Tag & Push image to ECR
        run: |
          docker tag akaunting-app:latest \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/akaunting:latest

          docker push \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/akaunting:latest


  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: ci

    strategy:
      matrix:
        php: ['8.1', '8.2', '8.3']

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: php-${{ matrix.php }}-composer-${{ hashFiles('composer.json') }}

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: bcmath, ctype, dom, fileinfo, intl, gd, json, mbstring, pdo, pdo_sqlite, openssl, sqlite, xml, zip
          coverage: none

      - run: cp .env.testing .env
      - run: composer install --no-interaction --prefer-dist
      - run: npm install
      - run: npm run production

      - name: Run tests (non-blocking)
        run: php artisan test
        continue-on-error: true

  sast:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: Semgrep JSON
        run: |
          semgrep scan \
            --config p/php \
            --config p/javascript \
            --json \
            --output semgrep.json \
            .

      - name: Semgrep SARIF
        run: |
          semgrep scan \
            --config p/php \
            --config p/javascript \
            --sarif \
            --output semgrep.sarif \
            .

      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        with:
          name: sast-semgrep-report
          path: |
            semgrep.json
            semgrep.sarif

  sca:
    name: SCA - Trivy
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v4

      - run: docker build -t akaunting-app .

      - name: Trivy JSON
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: akaunting-app
          format: json
          output: trivy-report.json
          severity: HIGH,CRITICAL
          exit-code: 0

      - name: Trivy Table
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --format table \
            akaunting-app > trivy-report.txt

      - name: Upload SCA report
        uses: actions/upload-artifact@v4
        with:
          name: sca-trivy-report
          path: |
            trivy-report.json
            trivy-report.txt



  dast:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest

    steps:
      #  Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Start application with Docker Compose
      - name: Start application
        run: |
          docker compose up --build -d
          sleep 90
      #  Verify application is reachable
      - name: Verify app is reachable
        run: |
          curl -I http://localhost:8000
      # Pull OWASP ZAP image (avoids warning)
      - name: Pull OWASP ZAP image
        run: |
          docker pull ghcr.io/zaproxy/zaproxy:stable
      #  Run OWASP ZAP Baseline Scan
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network=host \
            --user root \
            -v ${{ github.workspace }}:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:8000 \
            -r zap-report.html \
            -J zap-report.json \
            -w zap-report.md \
            -a || true
      #  Upload DAST reports
      - name: Upload DAST report
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-report
          path: |
            zap-report.html
            zap-report.json
            zap-report.md




  # dast:
  #   name: DAST - OWASP ZAP
  #   runs-on: ubuntu-latest
  #   needs: ci

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Start application
  #       run: |
  #         docker compose up --build -d
  #         sleep 90

  #     - run: curl -I http://localhost:8000

  #     - name: Run ZAP
  #       run: |
  #         docker run --network=host \
  #           -v ${{ github.workspace }}:/zap/wrk/:rw \
  #           ghcr.io/zaproxy/zaproxy:stable \
  #           zap-baseline.py \
  #           -t http://localhost:8000 \
  #           -r zap-report.html \
  #           -J zap-report.json \
  #           -w zap-report.md \
  #           -a || true

  #     - name: Upload DAST report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: dast-zap-report
  #         path: |
  #           zap-report.html
  #           zap-report.json
  #           zap-report.md

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: [ci, tests, sast, sca, dast]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install kubectl
        run: |
          curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region us-east-1 \
            --name akaunting-devsecops2

      - name: Deploy to Kubernetes (full stack)
        run: |
          # Namespace
          kubectl apply -f k8s/namespace.yaml

          # Database (docker-compose db equivalent)
          kubectl apply -f k8s/mysql-deployment.yaml
          kubectl apply -f k8s/mysql-service.yaml

          # App configuration
          kubectl apply -f k8s/app-configmap.yaml
          kubectl apply -f k8s/app-secret.yaml

          # Application + exposure
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Wait for MySQL
        run: |
          kubectl rollout status deployment/mysql -n akaunting

      - name: Wait for Akaunting rollout
        run: |
          kubectl rollout status deployment/akaunting -n akaunting
