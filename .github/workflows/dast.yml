name: DAST - OWASP ZAP

on:
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start application
        run: |
          docker compose up --build -d
          echo "Waiting for app to start..."
          sleep 90
          
      - name: Run ZAP Scan with direct Docker command
        run: |
          echo "Running ZAP scan directly..."
          docker run --rm \
            -v $(pwd):/zap/wrk/:rw \
            --add-host=host.docker.internal:host-gateway \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://host.docker.internal:8000 \
            -J zap-report.json \
            -w zap-report.md \
            -r zap-report.html \
            -a
          
      - name: List generated report files
        run: |
          echo "=== Generated Report Files ==="
          ls -la *.html *.json *.md 2>/dev/null || echo "No report files yet"
          
      - name: Upload ZAP reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-reports
          path: |
            *.html
            *.json
            *.md
          retention-days: 30
          if-no-files-found: error
          
      - name: Show quick summary
        run: |
          echo "========================================"
          echo "ZAP SECURITY SCAN COMPLETED"
          echo "========================================"
          echo "Reports generated:"
          ls *.html *.json *.md 2>/dev/null | while read file; do
            echo "â€¢ $file"
          done || echo "No report files found"
          echo ""
          echo "Download from Artifacts section above!"
          echo "========================================"
          
      - name: Stop containers
        if: always()
        run: docker compose down || true
